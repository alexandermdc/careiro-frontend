import api from './api';

export interface Vendedor {
  id_vendedor: string;
  nome: string;
   // Atualizar associaÃ§Ã£o (requer autenticaÃ§Ã£o de ADM)
  async update(id: string, data: Partial<CreateAssociacaoData>): Promise<Associacao> {
    try {
      console.log('ğŸ“ Atualizando associaÃ§Ã£o:', id);
      console.log('ğŸ“‹ Dados enviados:', data);
      
      const response = await api.put(`/associacao/${id}`, data);
      
      console.log('âœ… AssociaÃ§Ã£o atualizada com sucesso:', response.data);
      // Backend retorna { message, associacao }
      return response.data.associacao || response.data;
    } catch (error: any) {
      console.error('âŒ Erro ao atualizar associaÃ§Ã£o:', error);
      console.error('ğŸ“‹ Detalhes do erro:', error.response?.data);
      
      if (error.response?.status === 403) {
        throw new Error('Acesso negado. Apenas administradores podem atualizar associaÃ§Ãµes.');
      }
      
      throw new Error(error.response?.data?.message || error.response?.data?.error || 'Erro ao atualizar associaÃ§Ã£o');
    }
  }g;
  tipo_vendedor: 'PF' | 'PJ';
  tipo_documento?: 'CPF' | 'CNPJ';
  numero_documento?: string;
}

export interface Associacao {
  id_associacao: string;
  nome: string;
  descricao: string;
  vendedor?: Vendedor[]; // Array de vendedores vinculados
}

export interface CreateAssociacaoData {
  nome: string;
  descricao: string;
  // id_associacao Ã© gerado automaticamente pelo backend
  // vendedor serÃ¡ vinculado quando ele se cadastrar
}

class AssociacaoService {
  // Buscar todas as associaÃ§Ãµes (rota pÃºblica)
  async getAll(): Promise<Associacao[]> {
    try {
      console.log('ğŸ” Buscando todas as associaÃ§Ãµes...');
      const response = await api.get('/associacao');
      console.log('âœ… AssociaÃ§Ãµes encontradas:', response.data);
      return response.data;
    } catch (error: any) {
      console.error('âŒ Erro ao buscar associaÃ§Ãµes:', error);
      console.error('ğŸ“‹ Detalhes do erro:', error.response?.data);
      throw new Error(error.response?.data?.message || 'Erro ao buscar associaÃ§Ãµes');
    }
  }

  // Buscar associaÃ§Ã£o por ID (rota pÃºblica)
  async getById(id: string): Promise<Associacao> {
    try {
      console.log('ğŸ” Buscando associaÃ§Ã£o por ID:', id);
      const response = await api.get(`/associacao/${id}`);
      console.log('âœ… AssociaÃ§Ã£o encontrada:', response.data);
      return response.data;
    } catch (error: any) {
      console.error('âŒ Erro ao buscar associaÃ§Ã£o:', error);
      console.error('ğŸ“‹ Detalhes do erro:', error.response?.data);
      throw new Error(error.response?.data?.message || 'Erro ao buscar associaÃ§Ã£o');
    }
  }

  // Criar associaÃ§Ã£o (requer autenticaÃ§Ã£o de ADM)
  async create(data: CreateAssociacaoData): Promise<Associacao> {
    try {
      console.log('ğŸ“ Criando nova associaÃ§Ã£o...');
      console.log('ğŸ“‹ Dados enviados:', JSON.stringify(data, null, 2));
      console.log('ğŸ” Token atual:', localStorage.getItem('accessToken') ? 'Presente' : 'Ausente');
      
      const response = await api.post('/associacao/cadastro', data);
      
      console.log('âœ… AssociaÃ§Ã£o criada com sucesso:', response.data);
      // Backend retorna { message, associacao }
      return response.data.associacao || response.data;
    } catch (error: any) {
      console.error('âŒ Erro ao criar associaÃ§Ã£o:', error);
      console.error('ğŸ“‹ Detalhes completos do erro:', {
        message: error.message,
        status: error.response?.status,
        statusText: error.response?.statusText,
        data: error.response?.data,
        headers: error.response?.headers
      });
      
      // Tratamento especial para erro 403 (nÃ£o Ã© admin)
      if (error.response?.status === 403) {
        throw new Error('Acesso negado. Apenas administradores podem criar associaÃ§Ãµes.');
      }
      
      // Tentar extrair mensagem mais especÃ­fica
      const errorMessage = 
        error.response?.data?.message || 
        error.response?.data?.error ||
        error.response?.data?.mensagem ||
        error.response?.data ||
        error.message ||
        'Erro ao criar associaÃ§Ã£o';
      
      throw new Error(errorMessage);
    }
  }

  // Atualizar associaÃ§Ã£o (requer autenticaÃ§Ã£o)
  async update(id: string, data: Partial<CreateAssociacaoData>): Promise<Associacao> {
    try {
      console.log('âœï¸ Atualizando associaÃ§Ã£o ID:', id);
      console.log('ğŸ“‹ Dados para atualizaÃ§Ã£o:', data);
      
      const response = await api.put(`/associacao/${id}`, data);
      
      console.log('âœ… AssociaÃ§Ã£o atualizada:', response.data);
      return response.data;
    } catch (error: any) {
      console.error('âŒ Erro ao atualizar associaÃ§Ã£o:', error);
      console.error('ğŸ“‹ Detalhes do erro:', error.response?.data);
      throw new Error(error.response?.data?.message || 'Erro ao atualizar associaÃ§Ã£o');
    }
  }

  // Deletar associaÃ§Ã£o (requer autenticaÃ§Ã£o)
  async delete(id: string): Promise<void> {
    try {
      console.log('ğŸ—‘ï¸ Deletando associaÃ§Ã£o ID:', id);
      
      await api.delete(`/associacao/${id}`);
      
      console.log('âœ… AssociaÃ§Ã£o deletada com sucesso');
    } catch (error: any) {
      console.error('âŒ Erro ao deletar associaÃ§Ã£o:', error);
      console.error('ğŸ“‹ Detalhes do erro:', error.response?.data);
      throw new Error(error.response?.data?.message || 'Erro ao deletar associaÃ§Ã£o');
    }
  }
}

export default new AssociacaoService();